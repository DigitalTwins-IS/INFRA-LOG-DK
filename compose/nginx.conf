# API Gateway Configuration - Nginx
# Enruta todas las peticiones a los microservicios correspondientes

upstream ms_auth {
    server ms-auth-py:8000;
}

upstream ms_geo {
    server ms-geo-py:8000;
}

upstream ms_user {
    server ms-user-py:8000;
}

upstream ms_product {
    server ms-product-py:8000;
}

upstream ms_report {
    server ms-report-py:8000;
}

server {
    listen 80;
    server_name localhost;

    # Configuración de logs
    access_log /var/log/nginx/access.log;
    error_log /var/log/nginx/error.log;

    # Tamaño máximo de body
    client_max_body_size 10M;

    # CORS Headers
    add_header Access-Control-Allow-Origin * always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, Authorization" always;

    # Manejar preflight requests
    if ($request_method = OPTIONS) {
        return 204;
    }

    # Health check del API Gateway
    location /health {
        return 200 '{"status":"healthy","service":"API Gateway","version":"1.0.0"}';
        add_header Content-Type application/json;
    }

    # MS-AUTH-PY - Autenticación
    location /api/v1/auth {
        proxy_pass http://ms_auth/api/v1/auth;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # MS-GEO-PY - Servicios Geográficos
    location /api/v1/geo {
        proxy_pass http://ms_geo/api/v1/geo;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # MS-USER-PY - Gestión de Usuarios
    location /api/v1/users {
        proxy_pass http://ms_user/api/v1/users;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # MS-PRODUCT-PY - Gestión de Productos
    location /api/v1/products {
        proxy_pass http://ms_product/api/v1/products;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # MS-REPORT-PY - Reportes
    location /api/v1/reports {
        proxy_pass http://ms_report/api/v1/reports;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        proxy_connect_timeout 60s;
        proxy_send_timeout 60s;
        proxy_read_timeout 60s;
    }

    # Documentación de microservicios
    location /docs/auth {
        proxy_pass http://ms_auth/docs;
        proxy_set_header Host $host;
    }

    location /docs/geo {
        proxy_pass http://ms_geo/docs;
        proxy_set_header Host $host;
    }

    location /docs/users {
        proxy_pass http://ms_user/docs;
        proxy_set_header Host $host;
    }

    location /docs/products {
        proxy_pass http://ms_product/docs;
        proxy_set_header Host $host;
    }

    location /docs/reports {
        proxy_pass http://ms_report/docs;
        proxy_set_header Host $host;
    }

    # Página de bienvenida
    location = / {
        return 200 '{"message":"Digital Twins API Gateway","version":"1.0.0","endpoints":["/api/v1/auth","/api/v1/geo","/api/v1/users","/api/v1/products","/api/v1/reports"]}';
        add_header Content-Type application/json;
    }

    # Error handling
    error_page 502 503 504 /50x.html;
    location = /50x.html {
        return 502 '{"error":"Service temporarily unavailable"}';
        add_header Content-Type application/json;
    }
}
